<!DOCTYPE html>
<html >
  <head>
    <meta charset="UTF-8">
    <title>Market Wizard</title>

    <link href="lib/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
  </head>

  <body ng-app="MarketApp">
  <div> <!-- begin content -->
  <header id="my-header">
    <nav>
      <div><a href="/login">Log In</a>/<a ng-href="login()">Log Out</a></div>
    </nav>
  </header>

<!-- begin navbar -->
  <div class="navbar transparent navbar-inverse navbar-fixed-top">
     <nav class="navbar-inner">
    <div class="container-fluid">
      <div class="navbar-header">
        <div id="logo">Market Wizard</div>
      </div>
      <div id="navContents"><a href="#/login" id="logInLink">Log in /</a><a href="#/logout" id="logOutLink"> Log Out</a>
        <ul class="nav navbar-nav">
          <!-- <li class="active"><a href="/#/songs/list">To Nothing</a></li> -->
          <!-- <li><a href="/#/songs/form">To Nothing</a></li> -->
          <li><input ng-model="query" id="searchBox" type="text" class="form-control" placeholder="Search"></li>
        </ul>
      </div>
    </div>
  </nav>
  </div>
  </div> 
<!-- end navbar -->

    <div ng-view id="results"></div>

    <div id="tickerBoard">
    <div id="divMain">
    <script type='text/javascript'>
    function main()
    {
      new StockTracker
      (
        [
          new Stock("NASDAQ", "^IXIC"),
          new Stock("NASDAQ", "^GSPC"),
          new Stock("NASDAQ", "NFLX"),
          new Stock("NASDAQ", "MNST"),
          new Stock("NASDAQ", "GOOGL"),
        ]
      ).initialize();
    }
    function Stock(exchange, symbol, priceLast)
    {
      this.exchange = exchange;
      this.symbol = symbol;
      this.priceLast = priceLast;
    }
    {
      Stock.prototype.domElementUpdate = function(parentDomElement)
      {
        if (this.domElement == null)
        {
          var tr = document.createElement("tr");
          var td = document.createElement("td");
          tr.appendChild(td);
          var td = document.createElement("td");      
          tr.appendChild(td);
          this.domElement = tr;
          parentDomElement.appendChild(this.domElement);
        }
        var tdsAll = this.domElement.getElementsByTagName("td");
        var priceAsString;
        if (this.priceLast == null)
        {
          priceAsString = "?";
        }
        else
        {
          var centsPerDollar = 100;
          var cents = Math.floor(this.priceLast * centsPerDollar) % centsPerDollar;
          var dollarsAsString = "" + Math.floor(this.priceLast);
          var centsAsString = (cents < 10 ? "0" : "") + cents;
          priceAsString = dollarsAsString + "." + centsAsString;
        }
        tdsAll[0].innerHTML = this.symbol;
        tdsAll[1].innerHTML = priceAsString;
      }
      Stock.prototype.update = function()
      {
        this.updateViaGoogle();
      }
    // GOOG quote API deprecated in 2011, but still working
      Stock.prototype.updateViaGoogle = function()
      {
      
        var requestURL = 
          "https://www.google.com/finance/info?q="
          + this.exchange + ":" + this.symbol;
        var request = new XMLHttpRequest();
        request.open("GET", requestURL, false);
        try
        {
          request.send(null);
          var responseAsString = request.responseText;
          responseAsString = responseAsString.substr("////".length);
          var responseAsArray = JSON.parse(responseAsString);
          var responseAsObject = responseAsArray[0];
      
          this.priceLast = responseAsObject["l"]; // "latest"
        }
        catch(e)
        {
          this.priceLast = "?";
        }
      }
      
    // Yahoo quote API (as alternate - or for indexes)
      Stock.prototype.updateViaYahoo = function()
      {
        var requestURL = 
          "https://finance.yahoo.com/webservice/v1/symbols/" + this.symbol + "/quote?format=json";
        var request = new XMLHttpRequest();
        request.open("GET", requestURL, false);
        try
        {
          request.send(null);
          var responseAsString = request.responseText;
          var responseAsArray = JSON.parse(responseAsString);
          var responseAsObject = responseAsArray.list.resources[0].resource;
      
          this.priceLast = parseFloat(responseAsObject.fields.price);
        }
        catch(e)
        {
          this.priceLast = "?";
        }
      }
    }
    function StockTracker(stocksToTrack)
    {
      this.stocksToTrack = stocksToTrack;
    }
    {
      // constants
      StockTracker.Newline = "<br />";
      // instance methods
      StockTracker.prototype.initialize = function()
      {
        var millisecondsPerTimerTick = 20000;
        setInterval
        (
          this.handleEventTimerTick.bind(this),
          millisecondsPerTimerTick
        );
        this.handleEventTimerTick();
      }
      StockTracker.prototype.update = function()
      {
        for (var i = 0; i < this.stocksToTrack.length; i++)
        {
          var stock = this.stocksToTrack[i];
          stock.update();
        }
        this.domElementUpdate();
      }
      // output to the DOM
      StockTracker.prototype.domElementUpdate = function()
      {
        var divTracker = document.createElement("div");
        if (this.domElement == null)
        {
          var labelSymbolToAdd = document.createElement("label");
          labelSymbolToAdd.for = "inputSymbolToAdd";
          labelSymbolToAdd.innerHTML = "Add Ticker:";
          divTracker.appendChild(labelSymbolToAdd);
          var inputSymbolToAdd = document.createElement("input");
          inputSymbolToAdd.id = "inputSymbolToAdd";
          divTracker.appendChild(inputSymbolToAdd);

          var buttonSymbolAdd = document.createElement("button");
          buttonSymbolAdd.innerHTML = "Add";
          buttonSymbolAdd.onclick = this.buttonSymbolAdd_Click.bind(this);
          divTracker.appendChild(buttonSymbolAdd);
          
          var tableQuotes = document.createElement("table");
          tableQuotes.id = "tableQuotes";
          tableQuotes.border = "1px solid";
          var tr = document.createElement("tr");
          //var td = document.createElement("td");
          //td.innerHTML = "Exchange";
          //tr.appendChild(td);
          var td = document.createElement("td");
          td.width = "65px";
          td.innerHTML = "Symbol";
          tr.appendChild(td);
          var td = document.createElement("td");
          td.width = "65px";
          td.innerHTML = "Price";
          tr.appendChild(td);
          tableQuotes.appendChild(tr);
          for (var i = 0; i < this.stocksToTrack.length; i++)
          {
            var stock = this.stocksToTrack[i];
            stock.domElementUpdate(tableQuotes);
          }   
          divTracker.appendChild(tableQuotes);
          this.domElement = divTracker;
          var divMain = document.getElementById("divMain");
          divMain.appendChild(this.domElement);
        }
        var tableQuotes = document.getElementById("tableQuotes");
        for (var i = 0; i < this.stocksToTrack.length; i++)
        {
          var stock = this.stocksToTrack[i];
          stock.domElementUpdate(tableQuotes);
        }
      }
      // events
      StockTracker.prototype.buttonSymbolAdd_Click = function(e)
      {
        var inputSymbolToAdd = document.getElementById("inputSymbolToAdd");
        var stockToAddAsString = inputSymbolToAdd.value;
        var exchange;
        var symbol;
        if (stockToAddAsString.indexOf(":") == -1)
        {
          exchange = null;
          symbol = stockToAddAsString;
        }
        else
        {
          var stockToAddAsStrings = stockToAddAsString.split(":");
          exchange = stockToAddAsStrings[0] 
          symbol = stockToAddAsStrings[1];
        }
        
        var stock = new Stock
        (
          exchange, symbol
        );
        this.stocksToTrack.push(stock);
        this.update();
      }
      StockTracker.prototype.handleEventTimerTick = function()
      {
        this.update();  
      }
    }
    main();
    </script>
    </div>
    </div>

    <div id="chartButton"><button type="button" class="myButton" data-toggle="modal" data-target="#myModal">Chart</button>
    </div>

<!-- Modal for ticker added to watchlist -->
<div class="modal fade" id="addTickerModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Watchlist Update</h4>
      </div>
      <div class="modal-body">
      The ticker was successfully added to your watchlist.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for nightly update -->
<div class="modal fade" id="nightlyUpdateModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Nightly Data Update</h4>
      </div>
      <div class="modal-body">
      Nightly market data update successful.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for user-click update -->
<div class="modal fade" id="userDataUpdateModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Data Update</h4>
      </div>
      <div class="modal-body">
      Data update successful.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for chart -->
<div id="myModal" class="modal fade" role="dialog">
  <!-- <div class="modal-dialog"> -->
  <!-- Modal content below -->
    <!-- TradingView Widget BEGIN -->
    <div id="chartContainer">
    <div>
    <script type="text/javascript" src="https://d33t3vvu2t2yu5.cloudfront.net/tv.js"></script>
    <script type="text/javascript">
    new TradingView.widget({
      "width": 725,
      "height": 465,
      "symbol": "FX:SPX500",
      "interval": "D",
      "timezone": "Etc/UTC",
      "theme": "White",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#f1f3f6",
      "allow_symbol_change": true,
      "save_image": false,
      "hideideas": true,
      "studies": [
        "MASimple@tv-basicstudies"
      ]
    });
    </script>
    </div>
    <div id="chartModal" style="width:100%;height:300px;"></div>
        <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    </div>
    </div>
    <!-- TradingView Widget END -->
    <!-- Begin modal footer -->

  <!-- </div> -->
</div>

    <script src="lib/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="lib/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="lib/bower_components/angular/angular.min.js"></script>
    <script src="lib/bower_components/angular-route/angular-route.min.js"></script>
    <script src="lib/bower_components/firebase/firebase.js"></script>
    <script src="lib/bower_components/angularfire/dist/angularfire.min.js"></script>
    <script src="lib/bower_components/angular-filter/dist/angular-filter.min.js"></script>

    <script src="app/app.js"></script>
    <script src="app/controllers/masterListCtrl.js"></script>
<!--    <script src="app/controllers/watchlists.js"></script>  -->
    <script src="app/controllers/logInCtrl.js"></script>
    <script src="app/controllers/logOutCtrl.js"></script>
    <script> src="javascripts/scripts.js"</script>

  </body>
</html>